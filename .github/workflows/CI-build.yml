name: "ðŸ”¨ Build & Verify"
on:
  workflow_call

jobs:

  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    permissions:
      # actions/checkout
      contents: read
      # EnricoMi/publish-unit-test-result-action -> https://github.com/EnricoMi/publish-unit-test-result-action#permissions
      checks: write

    steps:

      - name: "Set up JDK 8."
        uses: actions/setup-java@v3
        with:
          java-version: 8
          distribution: temurin

      # Temporarily until Android SDK Platform-Tools updates post 34.0.4 in ubuntu-latest.
      # https://github.com/actions/runner-images/blob/ubuntu22/20231016.1/images/linux/Ubuntu2204-Readme.md#android
      - name: "Set up Android SDK"
        uses: android-actions/setup-android@v3

      - name: "Checkout ${{ github.ref }} branch in ${{ github.repository }} repository."
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: "Build project."
        working-directory: .
        run: >
          ./gradlew
          --no-daemon
          --stacktrace
          --continue
          --no-build-cache
          build -x :Android:lint

      - name: "Upload 'Unit Test Results' artifact."
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: 'Unit Test Results'
          path: ${{ github.workspace }}/**/build/reports/tests/*/

      - name: "Publish 'Unit Results' check suite."
        if: success() || failure()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          check_name: 'ðŸ”” Test: Unit Results'
          comment_mode: off
          report_individual_runs: true
          test_changes_limit: 0
          junit_files: ${{ github.workspace }}/**/build/test-results/*/TEST-*.xml

      - name: "Upload 'APKs' artifact."
        if: success() || failure()
        uses: actions/upload-artifact@v3
        with:
          name: 'APKs'
          path: |
            ${{ github.workspace }}/**/build/outputs/apk/
            ${{ github.workspace }}/**/build/outputs/mapping/
            ${{ github.workspace }}/**/build/outputs/logs/
            ${{ github.workspace }}/**/build/outputs/sdk-dependencies/
